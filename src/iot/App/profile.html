<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cicla â€“ Perfil</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#E6FFFB] flex justify-center">

<!-- APP FRAME -->
<div class="relative w-full max-w-[430px] min-h-screen bg-[#E6FFFB] flex flex-col">

  <!-- HEADER -->
  <div class="bg-gradient-to-br from-[#6CF7EB] to-[#69DCFF] px-6 pt-10 pb-12 relative">

    <button onclick="history.back()"
      class="absolute left-4 top-8 w-10 h-10 rounded-full bg-white/40 flex items-center justify-center">
      â†
    </button>

    <img src="./assets/cicla-bikeep-logo.png"
         class="absolute right-4 top-8 w-20" />

    <div class="mt-12 flex items-center gap-4">
      <div class="w-16 h-16 rounded-full bg-white shadow flex items-center justify-center text-2xl">
        ğŸ‘¤
      </div>
      <div>
        <h1 id="profileName" class="text-xl font-bold text-[#2F3A3A]"></h1>
        <p id="profileEmail" class="text-sm text-[#2F3A3A]/70"></p>
      </div>
    </div>
  </div>

  <!-- QUICK ACTIONS -->
  <div class="px-6 mt-6">
    <div class="bg-white rounded-3xl shadow p-5">
      <div class="grid grid-cols-3 gap-4 text-center">

        <button class="flex flex-col items-center gap-2">
          <div class="w-12 h-12 rounded-2xl bg-[#DFFAF6] flex items-center justify-center text-xl">
            ğŸš²
          </div>
          <span class="text-xs font-semibold text-[#2F3A3A]">
            As minhas bicicletas
          </span>
        </button>

        <button class="flex flex-col items-center gap-2">
          <div class="w-12 h-12 rounded-2xl bg-[#DFFAF6] flex items-center justify-center text-xl">
            ğŸ’³
          </div>
          <span class="text-xs font-semibold text-[#2F3A3A]">
            Pagamentos
          </span>
        </button>

        <button class="flex flex-col items-center gap-2">
          <div class="w-12 h-12 rounded-2xl bg-[#DFFAF6] flex items-center justify-center text-xl">
            âš™ï¸
          </div>
          <span class="text-xs font-semibold text-[#2F3A3A]">
            DefiniÃ§Ãµes
          </span>
        </button>

      </div>
    </div>
  </div>

  <!-- RESERVAS -->
  <div class="px-6 mt-10 flex-1 overflow-y-auto">
    <h2 class="font-bold text-[#2F3A3A] mb-4">Reservas</h2>

    <div id="bookingList" class="space-y-4"></div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="border-t bg-white px-6 py-3">
    <div class="flex justify-between">

      <a href="home.html" class="flex flex-col items-center text-[#2F3A3A]/60">
        ğŸ“
        <span class="text-xs font-semibold">Mapa</span>
      </a>

      <div class="flex flex-col items-center text-[#2F3A3A]">
        ğŸ‘¤
        <span class="text-xs font-semibold">Perfil</span>
      </div>

      <button onclick="logout()" class="flex flex-col items-center text-[#2F3A3A]/60">
        â‹
        <span class="text-xs font-semibold">Sair</span>
      </button>

    </div>
  </div>

</div>

<!-- LOGIC -->
<script>
  const rawUser = localStorage.getItem("user");
  let user = null;

  try {
    user = rawUser && rawUser !== "undefined" ? JSON.parse(rawUser) : null;
  } catch {
    user = null;
  }

  if (!user) {
    localStorage.removeItem("user");
    alert("Tem de iniciar sessÃ£o primeiro.");
    window.location.href = "signIn.html";
  }

  document.getElementById("profileName").innerText =
    user.name || user.username || "Utilizador";

  document.getElementById("profileEmail").innerText =
    user.email || "Sem email";

  // DEV TIME (replace with new Date() in production)
  const DEV_NOW = new Date("2025-12-17T09:30:00");
  const now = () => DEV_NOW;

  async function loadBookings() {
    const res = await fetch(
      `http://localhost:3000/reservations/user/${user._id}`
    );
    const bookings = await res.json();

    const container = document.getElementById("bookingList");
    container.innerHTML = "";

    bookings.forEach(b => {
      const start = new Date(b.startDateTime);
      const end = new Date(b.endDateTime);

      const card = document.createElement("div");
      card.className = "bg-white rounded-3xl p-5 shadow";

      card.innerHTML = `
        <div onclick="toggleDropdown('${b._id}')"
             class="flex items-center justify-between cursor-pointer mb-3">

          <div>
            <p class="font-bold text-sm text-[#2F3A3A]">
              ${b.cubicleId?.name || "Cicla Box"}
            </p>
            <p class="text-xs text-[#2F3A3A]/60">
              Lugar #${b.slot}
            </p>
          </div>

          <span class="px-3 py-1 rounded-full text-xs font-bold
            ${isActive(b)
              ? "bg-[#DFFAF6] text-[#2F3A3A]"
              : "bg-gray-200 text-gray-500"}">
            ${isActive(b) ? "Ativa" : "Passada"}
          </span>
        </div>

        <div id="dropdown-${b._id}" class="hidden border-t pt-3 text-xs text-[#2F3A3A]/80">
          ${start.toLocaleDateString()} â€¢ ${start.getHours()}h â€“ ${end.getHours()}h
          <div class="font-bold mt-1 text-[#2F3A3A]">â‚¬${b.price.toFixed(2)}</div>

          ${
            isWithinReservation(b)
              ? (b.isUnlocked
                  ? `<button onclick="lockCubicle('${b._id}', ${b.slot})"
                      class="w-full mt-3 py-2 rounded-xl border border-red-300 text-red-600 font-semibold">
                      ğŸ”’ Bloquear
                    </button>`
                  : `<button onclick="unlockCubicle('${b._id}', ${b.slot})"
                      class="w-full mt-3 py-2 rounded-xl border border-[#69DCFF] text-[#2F3A3A] font-semibold">
                      ğŸ”“ Desbloquear
                    </button>`
                )
              : `<div class="mt-3 text-center text-gray-400 font-semibold">
                  Fora do horÃ¡rio da reserva
                </div>`
          }
        </div>
      `;

      container.appendChild(card);
    });
  }

  function toggleDropdown(id) {
    document.querySelectorAll("[id^='dropdown-']").forEach(d => {
      if (d.id !== `dropdown-${id}`) d.classList.add("hidden");
    });
    document.getElementById(`dropdown-${id}`).classList.toggle("hidden");
  }

  function isWithinReservation(b) {
    const current = now();
    return current >= new Date(b.startDateTime) &&
           current <= new Date(b.endDateTime);
  }

  function isActive(b) {
    return isWithinReservation(b);
  }

  function logout() {
    localStorage.removeItem("user");
    window.location.href = "signIn.html";
  }

  async function unlockCubicle(id, slot) {
    if (Number(slot) !== 1) return alert("Apenas o Lugar 1 tem fechadura");
    await fetch(`http://localhost:3000/reservations/${id}/unlock`, { method: "POST" });
    loadBookings();
  }

  async function lockCubicle(id, slot) {
    if (Number(slot) !== 1) return alert("Apenas o Lugar 1 tem fechadura");
    await fetch(`http://localhost:3000/reservations/${id}/lock`, { method: "POST" });
    loadBookings();
  }

  loadBookings();
</script>

</body>
</html>
